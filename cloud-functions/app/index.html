<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" /> 
	<title>Looker API Environment</title>
	<!--<link rel="shortcut icon" href="favicon.ico" />-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
</head>
<body>
	<div id="auth-state" style="display:flex; flex-direction: row; justify-content:center; margin-top:4em;">
		<div style="width:600px;height:480px;position:relative;top:0;left:0">
			<a id="popup" target="popup" style="position:absolute;top:1em;right:1em;text-align:center;height:2em;width:2em;border-radius:50%;background:white">â§‰</a>
			<iframe id="auth-ifr" style="height:100%;width:100%"></iframe>
		</div>
		<div id="auth-pending" style="display:none; color:#999">Granting access...</div>
		<div id="auth-complete" style="display:none; color:#090; font-weight:bold">Access granted!</div>
	</div>
</body>
<script type="text/work-in-progress">!async function(){
let config = await $.getJSON("/config")

var catalogue = (config.pairings||[{}])
	.map(pair => {
			let instances = 
				pair.instance === undefined ? config.instances
				: typeof pair.instance == "object" ? pair.instance
				: typeof pair.instance == "string" 
					? (pair.instance.slice(0,1)=="/" && pair.instance.slice(-1)=="/" 
						? config.instances.filter(i => i.test(new Regex(pair.instance)))
						: [config.instances.find(i => i.id === pair.instance)]
						)
					: []
			let scripts = 
				pair.script === undefined ? config.scripts
				: typeof pair.script == "object" ? pair.script
				: typeof pair.script == "string" 
					? (pair.script.slice(0,1)=="/" && pair.script.slice(-1)=="/" 
						? config.scripts.filter(i => i.test(new Regex(pair.script)))
						: [config.scripts.find(i => i.id === pair.script)]
						)
					: []
			let integrations = []
			for(let instance of instances){for (let script of scripts){integrations.push({instance,script})}}
			return integrations
		})
	.reduce(flatten,[])
function flatten(a,b){return a.concat(b)}
</script>
<script>
var globalToken
var config = {
		lookerHost:"sandboxcl.dev.looker.com",
		lookerUiPort:443,
		lookerApiPort:19999,
		model:"embed_api_auth",
		explore:"auth",
		redirectPath:"",
		cloudFunctions:{
			host: "us-central1-data-proto.cloudfunctions.net",
			authPath: "function-3",
			corsPath: "cors"
			}
	}
var states={}

window.addEventListener("hashchange",handleHash)
$(document).ready(handleHash)

state = getNonce()
states[state]=true
let authUrl = (
		"https://"
		+config.lookerHost
		+(config.lookerUiPort=="443"?"":`:${config.lookerUiPort}`)
		+"/embed/explore"
		+`/${config.model}`
		+`/${config.explore}`
		+".html"
		+`?fields=${config.explore}.get_signature`
		+`&f[${config.explore}.external_url]=`+customEncode(config.redirectPath||(document.location.origin+document.location.pathname+document.location.search))
		+`&f[${config.explore}.external_state]=`+state
		+"&allow_login_screen=true"
	)
console.log(authUrl)
$("#auth-ifr")[0].src = authUrl
$("#popup")[0].href=authUrl
$("#popup").on("click",function(evt){evt.preventDefault();window.open(this);})
async function handleHash(){
	let h = getHashObj()
	console.log("Hashchange",h)
	setTimeout(()=>window.location.hash="#",0)
	switch(h.route){
		case "auth":
			try{
				if(!h.state || ! states[h.state]){return} // Guard against unexpected hash calls 
				$("#auth-state>*").hide()
				$("#auth-pending").show()
				let authResult = await $.getJSON(
					"https://"+config.cloudFunctions.host
					+"/"+config.cloudFunctions.authPath
					+"?aud="+encodeURIComponent(h.aud)
					+"&exp="+encodeURIComponent(h.exp)
					+"&sub="+encodeURIComponent(h.sub)
					+"&sig="+encodeURIComponent(h.sig)
					+(config.debug?"&debug="+encodeURIComponent(config.debug):"")
					)
				console.log(authResult)
				if(!authResult.access_token){throw authResult}
				globalToken = authResult.access_token
				//let testValue = await api("GET user")
				$("#auth-state>*").hide()
				$("#auth-complete").show()
				}
			catch(e){
				console.error(e)
				//TODO: Flash error message
				//TODO: refresh auth-ifr first... get new state, new signature
				$("#auth-state>*").hide()
				$("#auth-ifr").show()
				}
			break;
		}
	}

function customEncode(str){
	return (str
		.replace(/\//g,"$s")
		.replace(/\-/g,"$d")
		.replace(/\:/g,"$c")
		)
	}

function getHashObj(){
		return (location.hash
				.slice(1)
				.split('&')
				.filter(Boolean)
				.map(ss=>ss.replace(/^\//,"route="))
				.map(ss=>ss.split('='))
				.reduce((aa,a)=>({[decodeURIComponent(a[0])]:decodeURIComponent(a.slice(1).join('=')), ...aa}),{})
			);
	}

function api(endpoint,{token, qs={}, body}={}){
	let match = endpoint.match("^(GET|POST|PUT|PATCH|DELETE)? ?(.*)$")
	let method = match[1]||"GET"
	let path = match[2]
	return $.ajax({
		method,
		url: ("https://"+config.cloudFunctions.host
			+"/"+config.cloudFunctions.corsPath
			+"/"+config.lookerHost+(config.lookerApiPort=="443"?"":`:${config.lookerApiPort}`)
			+"/api/3.0/"+path
			+(method.includes("?")?"&":"?")
			+Object.entries(qs).map(([k,v])=>encodeURIComponent(k)+"="+encodeURIComponent(v)).join("&")
			),
		contentType: 'application/json',
		dataType: 'json',
		...(method!="GET"?{data: JSON.stringify(body)}:{}),
		headers:{"Authorization":"token "+(token||globalToken)}
		})
	}
function getNonce(len = 8){
	let arr = new Uint8Array(len / 2)
	window.crypto.getRandomValues(arr)
	return Array.from(arr).map(int=>'0'+int.toString(16).slice(-2)).join('')
	}
</script>
</html>